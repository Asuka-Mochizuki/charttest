<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.1.4/Chart.min.js"></script>
  <script src="jquery.inview.js"></script>
  <script src="Chart.bundle.js"></script>
  <title>chart API Test</title>
</head>
<body>
  <h1>チャートAPIテスト</h1>
  <br><br><br><br>
  <br><br><br><br>
  <br><br><br><br>
  <br><br><br><br>
  <br><br><br><br>
  <br><br><br><br>
  <br><br><br><br>
  <br><br><br><br>
  <br><br><br><br>
  <br><br><br><br>
  <br><br><br><br>
  <br><br><br><br>
  <canvas id="myChart">お使いのブラウザはcanvasに対応していません。</canvas>
  <script>
  $('#myChart').on('inview', function() {
    var ctx = document.getElementById("myChart").getContext('2d');
    // Define a plugin to provide data labels　棒グラフの上に数値を表示
    //http://www.chartjs.org/samples/latest/advanced/data-labelling.html
    Chart.plugins.register({
      afterDatasetsDraw: function(chart) {
        var ctx = chart.ctx;

        chart.data.datasets.forEach(function(dataset, i) {
          var meta = chart.getDatasetMeta(i);
          if (!meta.hidden) {
            meta.data.forEach(function(element, index) {
              // Draw the text in black, with the specified font
              ctx.fillStyle = 'rgb(0, 0, 0)';

              var fontSize = 16;
              var fontStyle = 'normal';
              var fontFamily = 'Helvetica Neue';
              ctx.font = Chart.helpers.fontString(fontSize, fontStyle, fontFamily);

              // Just naively convert to string for now
              var dataString = dataset.data[index].toString()+'万人';

              // Make sure alignment settings are correct
              ctx.textAlign = 'center';
              ctx.textBaseline = 'middle';

              var padding = 5;
              var position = element.tooltipPosition();
              ctx.fillText(dataString, position.x, position.y - (fontSize / 2) - padding);
            });
          }
        });
      }
    });
    //ツールチップを固定、それ以外はホバーしても出ないように
    var cnt;
    Chart.pluginService.register({
        beforeRender: function (chart) {
            if (chart.config.options.showAllTooltips) {
                // create an array of tooltips
                // we can't use the chart tooltip because there is only one tooltip per chart
                chart.pluginTooltips = [];
                chart.config.data.datasets.forEach(function (dataset, i) {
                    chart.getDatasetMeta(i).data.forEach(function (sector, j) {
                        chart.pluginTooltips.push(new Chart.Tooltip({
                            _chart: chart.chart,
                            _chartInstance: chart,
                            _data:  chart.data,
                            _options: chart.options.tooltips,
                            _active: [sector]
                        }, chart));
                    });
                });

                // turn off normal tooltips
                chart.options.tooltips.enabled = false;
            }
        },
        afterDraw: function (chart, easing) {
            if (chart.config.options.showAllTooltips) {
                // we don't want the permanent tooltips to animate, so don't do anything till the animation runs atleast once
                if (!chart.allTooltipsOnce) {
                    if (easing !== 1)
                        return;
                    chart.allTooltipsOnce = true;
                }
                cnt = 1;
                // turn on tooltips
                chart.options.tooltips.enabled = true;
                Chart.helpers.each(chart.pluginTooltips, function (tooltip) {
                  if (cnt == 5){ //5つ目のBarのみ表示するように設定
                    tooltip.initialize();
                    tooltip.update();
                    // we don't actually need this since we are not animating tooltips
                    tooltip.pivot();
                    //tooltip.transition(easing).draw();//drawしない（邪魔になってしまう）
                    //chart.options.tooltips.enabled = true;
                    chart.options.tooltips.enabled = false;
                  }
                  cnt = cnt +1;
                });
         }
       }
    })
    //ツールチップの表示位置を調整
    // Chart.Tooltip.positioners.custom = function(elements, eventPosition) {
    //   var tooltip = this;
    //   console.log(tooltip.eventPosition);
    //     return {
    //       x: tooltip.eventPosition.x,
    //       y: tooltip.eventPosition.y + 10
    //     }
    //   }
    var myChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ["2016年", "2020年", "2030年"],
        datasets: [{
          label: '人材数',
          backgroundColor: "#121554",
          borderColor: "#121554",
          data: [91.9, 92.3, 85.7]
        }, {
          label: '不足数',
          data: [17.1, 36.9, 78.9]
        }]
      },
      options: {
        tooltips: {
             callbacks: {
                 label: function(tooltipItems, data) {
                     return;
                     return '2019年をピークに産業人口は減少傾向に';
                 },
                 title: function(tooltipItems, data) {
                     return '2019年をピークに産業人口は減少傾向に';
                 }
             },
             titleFontSize:14,
             caretPadding:10,
             //position: 'custom'
         },
        showAllTooltips: true,
        barPercentage:1, responsive: true,
        legend: { display: false },
        scales: {
           xAxes: [{ display: true, stacked: true, gridLines: { display: false }, ticks: {fontSize: 17} }],
           yAxes: [{ display: true, stacked: true,
                    ticks: {
                      max: 190,
                      min: 10,
                      stepSize: 20,
                        callback:function(value, index, values){
                          return value + '万人';
                        }
                    }
                  }]
         },
         legend: {
             display: true,
             labels: {
                 fontColor: 'rgb(0, 0, 0)'
             }
         }
      },
    });
  });
  </script>
</body>
</html>
